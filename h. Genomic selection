#Perform genomic selection for traits in R, using NSCC if file is big
#extracted from https://github.com/MarcooLopez/Genomic-Selection/blob/master/single_environment.md
#numerical format for genotype file should be produced from plink --recodeA
#refer to b. Reformat genotype files #4. VCF fole to numeric genotype forat (for Genomic selection)

#to run in NSCC, upload R file and use sh file to run 
#bash
module load R
R CMD BATCH genomic_selection.R


#==================================================
# genomic_selection.R
#==================================================
#change file names, working directories and ensure phenotype and genotype files are properly formatted.
#genotype file should be .raw file from plink numerical format, with columns as samples and rows as SNPs, first six columns are FID IID PAT MAT SEX PHENOTYPE. (tab delimitted)
#phenotype file should be .txt file containing phenotypes of samples, in same order as genotype file. First column is ID. 


# Clean the working environment
rm(list = ls())

# Load libraries
library(BGLR)
library(rrBLUP)
library(data.table)
library(dplyr)

#==================================================
# Prepare input data
#==================================================

# Load data
X <- fread("$input_genotype.raw") # Load genotype numeric file
Y <- read.table($input_phenotype.txt, header = TRUE)  # Load phenotype file

# Make the "FID" column the row names for the genotype data
rownames(X) <- X$FID
# Remove the first six columns from the dataframe (FID, IID, PAT, MAT, SEX, PHENOTYPE)
X <- X[, -c(1:6)]

# Make the "ID" column the row names for the phenotype data
rownames(Y) <- Y$ID
# Remove the "ID" column from the dataframe
Y <- Y[, -1]
# Select a phenotype (the first column)
y <- Y[, 1]

# Remove SNP columns with zero standard deviation
X <- X %>% select_if(function(col) sd(col) > 0)

# Check data dimensions and contents
cat("Genotype matrix dimensions: ", dim(X), "\n")
cat("Phenotype vector length: ", length(y), "\n")

# Genomic relationship matrix
M <- scale(X)
G <- tcrossprod(M) / ncol(X) # Calculate the covariance matrix of genetic effects based on marker data

# Design matrix for individuals. In this case is a diagonal since there are no replicates
GID <- factor(rownames(Y), levels = rownames(Y))
Zg <- model.matrix(~GID-1)

#==================================================
# Comparative Genomic selection using different models
#==================================================

# Set WD for storage of results
#output_files_path <- "$path_for_output_files"
#setwd(output_files_path)

# Models
models <- c("GBLUP", "BRR", "LASSO", "BayesB")

# Choose which models. 1:GBLUP; 2:BRR; 3:LASSO; 4:BayesB
MODELS <- c(1, 2, 3, 4)

# Percentage of the data assigned to Testing set
percTST <- 0.3

# Number of replicates
m <- 5

#==================================================

for (mod in MODELS) {
  # Creation of seed for repeated randomizations
  set.seed(123)
  seeds <- round(seq(1E3, 1E6, length = m))
  
  # Matrix to store results. It will save the correlation for each partition
  outCOR <- matrix(NA, nrow = m, ncol = 1)
  colnames(outCOR) <- models[mod]
  
  # Number of iterations and burn-in for Bayesian models
  nIter <- 1200
  burnIn <- 200
  
  model <- models[mod]
  nTST <- round(percTST * nrow(Y))
  
  for (k in 1:m) {  # Loop for the replicates
    set.seed(seeds[k])
    indexTST <- sample(1:nrow(Y), size = nTST, replace = FALSE)
    yNA <- y
    yNA[indexTST] <- NA
    
    # Define the model-specific ETA
    if (model == "GBLUP")  ETA <- list(list(K = G, model = "RKHS"))
    if (model == "BRR")    ETA <- list(list(X = M, model = "BRR"))
    if (model == "LASSO")  ETA <- list(list(X = M, model = "BL"))
    if (model == "BayesB") ETA <- list(list(X = M, model = "BayesB"))
    
    # Fit the model
    fm <- BGLR(yNA, ETA = ETA, nIter = nIter, burnIn = burnIn)
    
    # Calculate the correlation
    outCOR[k, 1] <- cor(fm$yHat[indexTST], y[indexTST], use = "complete.obs")
  }
  
  # Save results
  save(outCOR, file = paste0("outCOR_", model, ".RData"))
}

# Load and combine results
OUT <- c()
for (mod in seq_along(models)) {
  filename <- paste0("outCOR_", models[mod], ".RData")    
  if (file.exists(filename)) {
    load(filename, verbose = TRUE)
    OUT <- cbind(OUT, outCOR)
  }    
}

# Summarize and plot the results
summary_stats <- round(rbind(Mean = apply(OUT, 2, mean), SD = apply(OUT, 2, sd)), 4)
print(summary_stats)

# Save the boxplot as a PNG file
png(filename = "GS_model_comparison_boxplot.png", width = 800, height = 600)
boxplot(OUT, ylab = "Accuracy", xlab = "Model", main = "GS model comparison of digital biomass prediction accuracy across 5 iterations.")
dev.off()
