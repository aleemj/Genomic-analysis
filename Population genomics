#all updated code and instructions for adrian_et_al_2024_arugula_ref_genome genomic analysis

#last updated 24072024

#Code below shows specifically all code used for analysis for the sake of reproducability and tracability purposes. 

#!/bin/bash

#Step 0 - Alignment of sequences to arugula reference and calling of variants
#alignment is found in sequencingalighnment_code_20240723.sh

#to open terminal with set parameters
qsub -I -l walltime=3:00:00 -l select=1:ncpus=1:mem=100G

#Step 1 - SNP Statistics and sample statistics
#Filtering statistics for each step can be found in plink directory of arugula alignment folder 
#LD Pruning 
module load bcftools
bcftools +prune -m 0.5 -w 1000 /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/final.vcf -Ov -o /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/final_prune.vcf

#Step 2 -  Admixture for all samples
cd /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Admixture
#check k value
for K in 1 2 3 4 5 6 7 8 9 10; \
do /home/users/nus/aleemj/admixture --cv /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/final.bed $K | tee log${K}.out; done\
#print k results
grep -h CV log*.out
#Plot in ggplot in R

#Step 3 - PCA for all samples, comparing 
#Calculation done in TASSEL if possible, otherwise have to do in plink
#plot in ggplot in R

#Step 3a - Filter genotype files based on landrace vs improved accessions
module load bcftools
cd /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype
bcftools view --samples-file /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/landrace.txt  /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/filtered_samples_final_prune.vcf > /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/landrace_prune.vcf
bcftools view --samples-file /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/landrace.txt  /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/filtered_samples_final.vcf > /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/landrace.vcf
bcftools view --samples-file /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/improved.txt  /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/filtered_samples_final_prune.vcf > /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/improved_prune.vcf
bcftools view --samples-file /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/improved.txt  /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/filtered_samples_final.vcf > /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/improved.vcf

#Step 4 - Nucleotide diversity/Tajima D/Fst/LD decay
#comparing landrace vs improved accessions 
#4a. nucleotide diversity
cd /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Nucleotide_diversity
vcftools --vcf /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/landrace_prune.vcf --window-pi 100000 --out landrace_prune_nucleotidediversity_100kb #window size 100kb
vcftools --vcf /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/improved_prune.vcf --window-pi 100000 --out improved_prune_nucleotidediversity_100kb #window size 100kb
#4b. tajima D
cd /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Tajima_D
vcftools --vcf /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/landrace_prune.vcf --TajimaD 100000 --out landrace_pruned_TajimaD_10kb #window size 100kb
vcftools --vcf /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/improved_prune.vcf --TajimaD 100000 --out improved_prune_TajimaD_10kb #window size 100kb
#4c. Fst
cd /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Fst
vcftools --vcf /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/final_prune.vcf --weir-fst-pop /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/landrace.txt --weir-fst-pop /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/improved.txt --fst-window-size 100000 --fst-window-step 1000 --out landrace_vs_improved_prune_FST_100kb #window size 100kb
#4d. LD Decay
cd /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Arugula_genotype
/home/users/nus/aleemj/PopLDdecay/bin/PopLDdecay -InVCF final.vcf -OutStat landrace_LDdecay -SubPop /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/landrace.txt
/home/users/nus/aleemj/PopLDdecay/bin/PopLDdecay -InVCF final.vcf -OutStat improved_LDdecay -SubPop /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/improved.txt

#Step 5a - Filter genotype files based on Admixture accessions
module load bcftools
cd /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype
bcftools view --samples-file /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/v1_isolated.txt  /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/final_prune.vcf > /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/v1_isolated_pruned.vcf
bcftools view --samples-file /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/v4_isolated.txt  /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/final_prune.vcf > /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/v4_isolated_pruned.vcf
bcftools view --samples-file /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/v5_isolated.txt  /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/final_prune.vcf > /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/v5_isolated_pruned.vcf
bcftools view --samples-file /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/v1_isolated.txt  /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/final.vcf > /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/v1_isolated.vcf
bcftools view --samples-file /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/v4_isolated.txt  /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/final.vcf > /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/v4_isolated.vcf
bcftools view --samples-file /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/v5_isolated.txt  /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/final.vcf > /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/v5_isolated.vcf
bcftools view --samples-file /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/isolated.txt  /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/final.vcf > /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/isolated.vcf

#Step 5 Plot admixture with ggplot for just isolated samples 
#use ggplot in R, no need to recalculate admixture. Manually isolate and plot isolated samples. 

#Step 6 - Plot PCA with ggplot for just isolated samples 
#use ggplot in R, no need to recalculate PCA. Manually isolate and plot isolated samples. 

#Step 7 - Nucleotide diversity/Tajima D/Fst/LD decay
#comparing isolated admixture clusters
#7a. nucleotide diversity
cd /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Nucleotide_diversity
vcftools --vcf /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/v1_isolated_pruned.vcf --window-pi 100000 --out v1_isolated_pruned_nucleotidediversity_100kb #window size 100kb
vcftools --vcf /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/v4_isolated_pruned.vcf --window-pi 100000 --out v4_isolated_pruned_nucleotidediversity_100kb #window size 100kb
vcftools --vcf /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/v5_isolated_pruned.vcf --window-pi 100000 --out v5_isolated_pruned_nucleotidediversity_100kb #window size 100kb
#7b. tajima D
cd /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Tajima_D
vcftools --vcf /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/v1_isolated_pruned.vcf --TajimaD 100000 --out v1_isolated_pruned_TajimaD_10kb #window size 100kb
vcftools --vcf /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/v4_isolated_pruned.vcf --TajimaD 100000 --out v4_isolated_pruned_TajimaD_10kb #window size 100kb
vcftools --vcf /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/v5_isolated_pruned.vcf --TajimaD 100000 --out v5_isolated_pruned_TajimaD_10kb #window size 100kb
#7c. Fst
cd /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Fst
vcftools --vcf /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/final_prune.vcf --weir-fst-pop /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/v1_isolated.txt --weir-fst-pop /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/v4_isolated.txt --fst-window-size 100000 --fst-window-step 1000 --out v1_vs_v4_isolated_prune_FST_100kb #window size 100kb
vcftools --vcf /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/final_prune.vcf --weir-fst-pop /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/v1_isolated.txt --weir-fst-pop /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/v5_isolated.txt --fst-window-size 100000 --fst-window-step 1000 --out v1_vs_v5_isolated_prune_FST_100kb #window size 100kb
vcftools --vcf /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/final_prune.vcf --weir-fst-pop /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/v4_isolated.txt --weir-fst-pop /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/v5_isolated.txt --fst-window-size 100000 --fst-window-step 1000 --out v4_vs_v4_isolated_prune_FST_100kb #window size 100kb
#7d. LD Decay
cd /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Arugula_genotype
/home/users/nus/aleemj/PopLDdecay/bin/PopLDdecay -InVCF final.vcf -OutStat landrace_LDdecay -SubPop /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/landrace.txt
/home/users/nus/aleemj/PopLDdecay/bin/PopLDdecay -InVCF final.vcf -OutStat improved_LDdecay -SubPop /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Accession_groups/improved.txt

#Step 8 - Phylogenetic Tree
cd /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Phylogenetics
module load r/4.2.0
/home/users/nus/aleemj/VCF2Dis-1.51/bin/VCF2Dis -InPut /home/users/nus/aleemj/scratch/adrian_et_al_2024_arugula_ref_genome/Genotype/isolated.vcf -OutPut isolated_p_dis.mat
#Plot it Figtree, check if have NWT file output, otherwise have to use R code to convert:
if(!require(ape)) install.packages("ape")
library(ape)
# read data from file 
matrix_data <- read.table("isolated_p_dis.mat", header=F, row.names=1,skip=1)
dist_matrix <- as.dist(as.matrix(matrix_data))
# Construct a tree using UPGMA/NJ method
# tree <-  as.phylo(hclust(dist_matrix, method = "average"))   # your can try UPGMA
tree <- nj(dist_matrix)
# print tree
#pdf("treeA.pdf") ;print(tree); dev.off();
# save the tree to Newick format file
write.tree(tree, file="output_tree.nwk") 
